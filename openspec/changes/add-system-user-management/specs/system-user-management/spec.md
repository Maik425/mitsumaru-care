## ADDED Requirements

### Requirement: システム管理者向けユーザー一覧表示機能

MUST: システム管理者は全施設のユーザー一覧を表示・管理できる。

#### Scenario: 全ユーザー一覧の表示

- **WHEN** システム管理者がユーザー管理画面にアクセスする
- **THEN** 全施設のユーザー一覧が表示される
- **AND** 各ユーザーの基本情報（名前、メール、ロール、所属施設、ステータス）が表示される

#### Scenario: 施設別ユーザーフィルタリング

- **WHEN** システム管理者が特定の施設を選択してフィルタリングする
- **THEN** 該当施設のユーザーのみが表示される
- **AND** フィルター条件が明確に表示される

#### Scenario: ユーザー検索機能

- **WHEN** システム管理者がユーザー名やメールアドレスで検索する
- **THEN** 該当するユーザーが検索結果に表示される
- **AND** 部分一致検索が可能である

### Requirement: システム管理者向けユーザー作成機能

MUST: システム管理者は新しいユーザーアカウントを作成できる。

#### Scenario: 新規ユーザーの作成

- **WHEN** システム管理者が新規ユーザー作成フォームに入力して送信する
- **THEN** Supabase Authにユーザーが作成される
- **AND** usersテーブルにレコードが追加される
- **AND** 指定されたロールと施設が設定される

#### Scenario: ユーザー作成時のバリデーション

- **WHEN** 必須項目が未入力または無効な値が入力された場合
- **THEN** 適切なエラーメッセージが表示される
- **AND** ユーザー作成は実行されない

#### Scenario: 重複メールアドレスのチェック

- **WHEN** 既存のメールアドレスでユーザー作成を試行する
- **THEN** 重複エラーメッセージが表示される
- **AND** ユーザー作成は実行されない

### Requirement: システム管理者向けユーザー編集機能

MUST: システム管理者は既存のユーザー情報を編集できる。

#### Scenario: ユーザー情報の更新

- **WHEN** システム管理者がユーザー情報を編集して保存する
- **THEN** usersテーブルの該当レコードが更新される
- **AND** 変更内容が即座に一覧に反映される

#### Scenario: ユーザーロールの変更

- **WHEN** システム管理者がユーザーのロールを変更する
- **THEN** ユーザーの権限が即座に更新される
- **AND** 権限変更履歴が記録される

#### Scenario: ユーザー施設の変更

- **WHEN** システム管理者がユーザーの所属施設を変更する
- **THEN** ユーザーの施設IDが更新される
- **AND** 施設変更履歴が記録される

### Requirement: システム管理者向けユーザー削除機能

MUST: システム管理者は不要になったユーザーアカウントを削除できる。

#### Scenario: ユーザーアカウントの削除

- **WHEN** システム管理者がユーザー削除ボタンをクリックして確認する
- **THEN** Supabase Authからユーザーが削除される
- **AND** usersテーブルからもレコードが削除される
- **AND** 関連する勤怠記録等は保持される

#### Scenario: 削除確認ダイアログ

- **WHEN** システム管理者がユーザー削除ボタンをクリックする
- **THEN** 削除確認ダイアログが表示される
- **AND** 削除の影響範囲が説明される

### Requirement: システム管理者向けユーザー権限管理機能

MUST: システム管理者はユーザーの権限を包括的に管理できる。

#### Scenario: ユーザー権限の一覧表示

- **WHEN** システム管理者がユーザー詳細を表示する
- **THEN** そのユーザーの現在の権限が表示される
- **AND** 権限変更履歴が表示される

#### Scenario: 権限の昇格・降格

- **WHEN** システム管理者がユーザーの権限を変更する
- **THEN** 新しい権限が即座に適用される
- **AND** 権限変更が監査ログに記録される

#### Scenario: 権限変更の制限

- **WHEN** システム管理者が自分自身の権限を変更しようとする
- **THEN** 適切な警告メッセージが表示される
- **AND** 自己権限変更は制限される

### Requirement: システム管理者向けユーザー状態管理機能

MUST: システム管理者はユーザーアカウントの有効/無効状態を管理できる。

#### Scenario: ユーザーアカウントの無効化

- **WHEN** システム管理者がユーザーアカウントを無効化する
- **THEN** usersテーブルのis_activeフラグがfalseに更新される
- **AND** 該当ユーザーはログインできなくなる

#### Scenario: ユーザーアカウントの有効化

- **WHEN** システム管理者が無効化されたアカウントを有効化する
- **THEN** usersテーブルのis_activeフラグがtrueに更新される
- **AND** 該当ユーザーは再びログインできるようになる

#### Scenario: バッチ状態変更

- **WHEN** システム管理者が複数ユーザーを選択して状態を一括変更する
- **THEN** 選択された全ユーザーの状態が一括更新される
- **AND** 変更結果が一覧に反映される

#### Scenario: バッチ操作の確認ダイアログ

- **WHEN** システム管理者がバッチ操作を実行する
- **THEN** 操作対象のユーザー数と操作内容が確認ダイアログに表示される
- **AND** 確認後にバッチ操作が実行される

#### Scenario: バッチ操作の部分失敗処理

- **WHEN** バッチ操作中に一部のユーザーでエラーが発生する
- **THEN** 成功したユーザーは更新され、失敗したユーザーはエラー表示される
- **AND** エラーの詳細と対処法が表示される
