# AGENTS.md

このドキュメントは、AIエージェントがこのプロジェクトで作業する際のガイドラインです。

## プロジェクト構造

このプロジェクトは`src`ディレクトリ構造を使用しています：

```
mitsumaru-care/
├── src/
│   ├── app/           # Next.js App Router
│   │   ├── system/    # システム管理者向けページ
│   │   ├── facility/  # 施設管理者向けページ（旧admin）
│   │   ├── user/      # 一般ユーザー向けページ
│   │   ├── api/       # API ルート
│   │   ├── layout.tsx # ルートレイアウト
│   │   └── page.tsx   # ホームページ
│   ├── components/    # Reactコンポーネント
│   │   ├── ui/        # shadcn/ui コンポーネント
│   │   └── *.tsx      # カスタムコンポーネント
│   ├── lib/          # ユーティリティ関数
│   ├── hooks/        # カスタムフック
│   └── styles/       # スタイルファイル
├── public/           # 静的ファイル（画像、アイコンなど）
├── tsconfig.json     # TypeScript設定
├── next.config.mjs   # Next.js設定
└── package.json      # 依存関係
```

## 開発フロー

### コード修正後の必須手順

**すべてのコード修正後は、必ず以下のコマンドを実行してください：**

```bash
pnpm exec tsc
```

このコマンドにより、TypeScriptの型エラーがないことを確認できます。

### 推奨される作業手順

1. **修正前の確認**

   ```bash
   pnpm exec tsc
   ```

2. **コードの修正**
   - ファイルの編集
   - 新しいコンポーネントの追加
   - 既存コンポーネントの修正

3. **修正後の確認**

   ```bash
   pnpm exec tsc
   ```

4. **エラーがある場合**
   - TypeScriptエラーを修正
   - 再度 `pnpm exec tsc` を実行
   - エラーが解消されるまで繰り返し

## 重要な設定

### TypeScript設定

- `@/*` エイリアスは `./src/*` を指します
- 厳密な型チェックが有効になっています

### Next.js設定

- App Routerを使用
- TypeScriptエラーは無視されません（開発時は確認が重要）

### コンポーネント

- shadcn/ui を使用
- カスタムコンポーネントは `src/components/` に配置
- UIコンポーネントは `src/components/ui/` に配置

## 注意事項

1. **インポートパス**: `@/components/...` 形式でインポートしてください
2. **型安全性**: すべてのコンポーネントで適切な型定義を使用してください
3. **エラーハンドリング**: TypeScriptエラーは必ず修正してください
4. **ファイル構造**: 新しいファイルは適切なディレクトリに配置してください
5. **ドキュメント更新**: 機能実装後は必ず `docs/PR/` ディレクトリのドキュメントを更新してください

## 将来の拡張

このプロジェクトはtRPCサーバーと認証システムを統合済みです：

```
src/
├── app/           # Next.js App Router
│   ├── system/    # システム管理者向けページ
│   ├── facility/  # 施設管理者向けページ
│   ├── user/      # 一般ユーザー向けページ
│   └── api/       # API ルート
├── components/    # Reactコンポーネント
├── lib/          # ユーティリティ関数
├── hooks/        # カスタムフック
├── server/       # tRPCサーバー
└── styles/       # スタイルファイル
```

## データベースマイグレーション

### マイグレーションファイルの作成ルール

1. **ファイル名**: `supabase/migrations/001_initial_schema.sql` 形式
2. **日時は不要**: ファイル名に日時を含めない
3. **まとめて作成**: 関連するテーブルは1つのマイグレーションファイルにまとめる
4. **順序**: 依存関係を考慮してテーブル作成順序を決める
5. **ダミーデータ**: 必要に応じて同じファイルにINSERT文を含める

### マイグレーション実行手順

1. マイグレーションファイルをSupabaseにアップロード
2. マイグレーションを実行（自動的にリセットとセットアップが実行されます）
3. データの確認

**注意**: `001_initial_schema.sql`には完全なリセット機能が含まれています：

- 既存テーブルの削除
- Authenticationユーザーの削除
- 新しいスキーマの作成
- テーブル、RLSポリシー、ダミーデータの作成

### データベース接続情報

**重要**: データベースパスワードや接続情報が必要な場合は、以下のファイルを確認してください：

```bash
cat confidential/supabase-connection.env
```

このファイルにはSupabaseデータベースの接続情報が保存されています。

- ファイルは`confidential/`ディレクトリにあり、`.gitignore`に含まれており、gitにはコミットされません

## トラブルシューティング

### TypeScriptエラーが発生した場合

1. `pnpm exec tsc` でエラーを確認
2. エラーメッセージを読んで問題を特定
3. 型定義やインポートパスを修正
4. 再度 `pnpm exec tsc` で確認

### ビルドエラーが発生した場合

1. `.next` ディレクトリを削除: `rm -rf .next`
2. `pnpm exec tsc` で型エラーを確認
3. エラーを修正後、再度ビルドを試行

---

**重要**: すべてのコード修正後は必ず `pnpm exec tsc` を実行して、TypeScriptエラーがないことを確認してください。
